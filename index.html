<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>勉強・非勉強トラッカー（同期版）</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:#334155;
      --accent:#22c55e;
      --accent2:#3b82f6;
      --warn:#f59e0b;
      --danger:#ef4444;
      --study:#22c55e;
      --idle:#f59e0b;
      --stop:#64748b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,sans-serif;
      background:linear-gradient(180deg,#0b1220,#0f172a 45%,#111827);
      color:var(--text);
      line-height:1.5;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px; }
    h1,h2,h3,p{margin:0}
    .header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:18px; flex-wrap:wrap; }
    .sub{ color:var(--muted); margin-top:6px; font-size:14px; }
    .grid{ display:grid; gap:16px; }
    .grid-2{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    .grid-3{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    .card{ background:rgba(17,24,39,0.9); border:1px solid var(--line); border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .space{ justify-content:space-between; }
    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input, button { font:inherit; border-radius:12px; border:1px solid var(--line); }
    input{ width:100%; padding:12px 14px; background:#0b1220; color:var(--text); }
    button{ padding:12px 16px; color:white; background:#1e293b; cursor:pointer; transition:opacity .2s; }
    button:hover{opacity:.95}
    button.primary{background:var(--accent2)}
    button.study{background:var(--study)}
    button.idle{background:var(--idle); color:#111827}
    button.stop{background:var(--stop)}
    button.danger{background:var(--danger)}
    .status-badge{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px; border:1px solid var(--line); background:#0b1220; font-weight:600; }
    .dot{ width:10px; height:10px; border-radius:50%; background:#64748b; }
    .dot.study{background:var(--study)}
    .dot.idle{background:var(--idle)}
    .dot.stop{background:var(--stop)}
    .metric{ background:#0b1220; border:1px solid var(--line); border-radius:16px; padding:14px; }
    .metric .name{ font-size:13px; color:var(--muted); margin-bottom:6px; }
    .metric .value{ font-size:28px; font-weight:800; }
    .metric .small{ font-size:14px; color:var(--muted); margin-top:4px; }
    .tiny{font-size:12px}
    .ok{color:#86efac} .warn{color:#fcd34d} .danger-t{color:#fca5a5} .muted{color:var(--muted)}
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th,td{ text-align:left; padding:10px 8px; border-bottom:1px solid rgba(148,163,184,0.15); }
    th{ color:var(--muted); font-weight:600; font-size:13px; }
    .pill{ display:inline-flex; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid transparent; }
    .pill.study{background:rgba(34,197,94,.15); color:#86efac; border-color:rgba(34,197,94,.25)}
    .pill.idle{background:rgba(245,158,11,.18); color:#fcd34d; border-color:rgba(245,158,11,.25)}
    .goal-input{ width:110px; }
    .progress{ margin-top:10px; height:10px; border-radius:999px; overflow:hidden; background:#0f172a; border:1px solid rgba(148,163,184,0.18); }
    .progress > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); transition:width .2s ease; }
    @media (max-width: 860px){ .grid-2,.grid-3{grid-template-columns:1fr} button{width:100%} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>勉強・非勉強トラッカー</h1>
        <p class="sub">Supabase 同期版 (v3)</p>
      </div>
      <div class="status-badge">
        <span id="statusDot" class="dot stop"></span>
        <span id="statusText">未接続</span>
      </div>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <div class="row space"><h2>1. 接続設定</h2><button id="clearConfigBtn">設定削除</button></div>
        <div style="margin-top:14px"><label>Supabase URL</label><input id="supabaseUrl" placeholder="https://..." /></div>
        <div style="margin-top:12px"><label>Anon Key</label><input id="supabaseAnonKey" placeholder="eyJ..." /></div>
        <div class="row" style="margin-top:14px"><button class="primary" id="saveConfigBtn">保存 & 接続</button></div>
        <p id="configMessage" class="tiny" style="margin-top:10px"></p>
      </section>
      <section class="card">
        <div class="row space"><h2>2. ログイン</h2><button id="logoutBtn" class="danger">ログアウト</button></div>
        <div style="margin-top:14px"><label>Email</label><input id="emailInput" placeholder="you@example.com" /></div>
        <div class="row" style="margin-top:14px"><button class="primary" id="loginBtn">マジックリンク送信</button></div>
        <p id="authMessage" class="tiny" style="margin-top:10px"></p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div class="row space"><h2>3. 記録</h2><div class="muted tiny" id="userInfo">未ログイン</div></div>
      <div class="row" style="margin-top:14px">
        <button class="study" id="studyBtn">勉強</button>
        <button class="idle" id="idleBreakBtn">休憩</button>
        <button class="idle" id="idleYoutubeBtn">YouTube</button>
        <button class="idle" id="idleOtherBtn">その他</button>
        <button class="stop" id="stopBtn">停止</button>
        <button id="syncNowBtn">同期</button>
      </div>
      <div class="grid grid-3" style="margin-top:16px">
        <div class="metric"><div class="name">状態</div><div class="value" id="currentModeLabel">停止中</div></div>
        <div class="metric"><div class="name">経過時間</div><div class="value" id="currentElapsed">00:00:00</div></div>
        <div class="metric"><div class="name">最終同期</div><div class="value" id="lastSyncLabel" style="font-size:20px">-</div></div>
      </div>
      <p id="trackerMessage" class="tiny" style="margin-top:10px"></p>
    </section>

    <div class="grid grid-3" style="margin-top:16px">
       <section class="card">
         <h2>今日</h2>
         <div style="margin-top:12px">
           <label>目標時間</label>
           <div class="row">
             <input id="goalHoursInput" class="goal-input" type="number" placeholder="2"> <span class="goal-unit">時間</span>
             <input id="
